<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.xr.exchange.dao.AdminDao">
    <resultMap id="baseResultMap" type="com.xr.exchange.model.AdminBean">
        <id column="id" property="id" jdbcType="INTEGER"/>
        <id column="username" property="username" jdbcType="VARCHAR"/>
        <id column="password" property="password" jdbcType="VARCHAR"/>
        <id column="realname" property="realname" jdbcType="VARCHAR"/>
        <id column="phone" property="phone" jdbcType="VARCHAR"/>
        <id column="level" property="level" jdbcType="INTEGER"/>
        <id column="money" property="money" jdbcType="DECIMAL"/>
        <id column="back_ratio" property="backRatio" jdbcType="FLOAT"/>
        <id column="red_ratio" property="redRatio" jdbcType="FLOAT"/>
        <id column="company_name" property="companyName" jdbcType="VARCHAR"/>
        <id column="company_lead" property="companyLead" jdbcType="VARCHAR"/>
        <id column="company_phone" property="companyPhone" jdbcType="VARCHAR"/>
        <id column="company_tel" property="companyTel" jdbcType="VARCHAR"/>
        <id column="company_address" property="companyAddress" jdbcType="VARCHAR"/>
        <id column="jiaoyisuo_id" property="jiaoyisuoId" jdbcType="INTEGER"/>
        <id column="yunying_id" property="yunyingId" jdbcType="INTEGER"/>
        <id column="zonghe_id" property="zongheId" jdbcType="INTEGER"/>
        <id column="weiquan_id" property="weiquanId" jdbcType="INTEGER"/>
        <id column="last_login_time" property="lastLoginTime" jdbcType="TIMESTAMP"/>
        <id column="last_login_ip" property="lastLoginIp" jdbcType="VARCHAR"/>
        <id column="status" property="status" jdbcType="VARCHAR"/>
        <id column="add_time" property="addTime" jdbcType="TIMESTAMP"/>
    </resultMap>

    <sql id="base_column_list">
        t.id,
        t.username,
        t.password,
        t.realname,
        t.phone,
        t.level,
        t.money,
        t.back_ratio,
        t.red_ratio,
        t.company_name,
        t.company_lead,
        t.company_phone,
        t.company_tel,
        t.company_address,
        t.jiaoyisuo_id,
        t.yunying_id,
        t.zonghe_id,
        t.weiquan_id,
        t.last_login_time,
        t.last_login_ip,
        t.status,
        t.add_time
    </sql>

    <select id="getAllAdmin" resultMap="baseResultMap">
        select
        <include refid="base_column_list"/>
        from t_admin t
        where 1 = 1
        <if test="showLevel != null and showLevel != ''">
            <if test="(showLevel==2 or showLevel==3 or showLevel==4) and loginAdmin.level == 1">
                AND t.jiaoyisuo_id = #{loginAdmin.id} AND t.level = #{showLevel}
            </if>
            <if test="(showLevel==3 or showLevel==4) and loginAdmin.level == 2">
                AND t.yunying_id = #{loginAdmin.id} AND t.level = #{showLevel}
            </if>
            <if test="(showLevel==4) and loginAdmin.level == 3">
                AND t.zonghe_id = #{loginAdmin.id} AND t.level = #{showLevel}
            </if>
        </if>
        <if test="adminListBean.conditions!=null and adminListBean.conditions!=''">
            and (t.username LIKE '%' #{adminListBean.conditions} '%' or t.realname LIKE '%' #{adminListBean.conditions}
            '%' or t.phone LIKE '%'
            #{adminListBean.conditions} '%')
        </if>
        <if test="adminListBean.addStartTime!=null and adminListBean.addStartTime!=''">
            AND t.add_time &gt;= CONCAT(#{adminListBean.addStartTime},' 00:00:00')
        </if>
        <if test="adminListBean.addEndTime!=null and adminListBean.addEndTime!=''">
            AND t.add_time &lt;= CONCAT(#{adminListBean.addEndTime},' 23:59:59')
        </if>
    </select>

    <select id="getCountAdmin" resultType="int">
        select count(1) FROM t_admin WHERE username = trim(#{username})
    </select>
    <update id="upPassword">
        update  t_admin set password = #{password} WHERE password = #{oldpassword} AND  id = #{id}
    </update>
    <select id="getCountAdminLogin" resultMap="baseResultMap">
        select * FROM t_admin WHERE username = trim(#{username}) AND password = trim(#{password}) AND status = 1
    </select>

    <insert id="saveAdmin" parameterType="AdminBean" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO `t_admin` ( `username`, `password`, `realname`, `phone`, `level`, `money`, `back_ratio`, `red_ratio`, `company_name`, `company_lead`, `company_phone`, `company_tel`, `company_address`, `jiaoyisuo_id`,`yunying_id`,`zonghe_id`,`weiquan_id`, `last_login_time`, `last_login_ip`, `status`, `add_time`) VALUES
	( TRIM(#{username}), #{password}, TRIM(#{realname}), TRIM(#{phone}), #{level}, #{money},TRIM(#{backRatio}), TRIM(#{redRatio}), #{companyName}, #{companyLead}, #{companyPhone}, #{companyTel}, #{companyAddress}, #{jiaoyisuoId},#{yunyingId},#{zongheId},#{weiquanId}, #{lastLoginTime}, #{lastLoginIp}, #{status}, #{addTime})
    </insert>

    <update id="upateStatus" parameterType="string">
        UPDATE t_admin set status = #{status} where username = #{username}
    </update>
    <update id="upateKeyId">
        <if test="adminBean.level!=null and adminBean.level==1">
        UPDATE t_admin set yunying_id = #{id} where id = #{id}
        </if>
        <if test="adminBean.level!=null and adminBean.level==2">
            UPDATE t_admin set zonghe_id = #{id} where id = #{id}
        </if>
        <if test="adminBean.level!=null and adminBean.level==3">
            UPDATE t_admin set weiquan_id = #{id} where id = #{id}
        </if>
    </update>
    <delete id="delete" parameterType="string">
        DELETE FROM t_admin WHERE username = #{username}
    </delete>

    <select id="getAdmin" parameterType="int" resultMap="baseResultMap">
        SELECT
        <include refid="base_column_list"/>
        FROM t_admin t
        WHERE id = #{id}
    </select>

    <update id="updateAdmin">
        UPDATE t_admin SET
        <if test="username != null and username != ''">
            username = #{username, jdbcType=VARCHAR}
        </if>
        <if test="password != null and password != ''">
            ,password = #{password, jdbcType=VARCHAR}
        </if>
        <if test="realname != null and realname != ''">
            ,realname = #{realname, jdbcType=VARCHAR}
        </if>
        <if test="phone != null and phone != ''">
            ,phone = #{phone, jdbcType=VARCHAR}
        </if>
        <if test="level != null and level != ''">
            ,level = #{level, jdbcType=INTEGER}
        </if>
        <if test="money != null and money != ''">
            ,money = #{money, jdbcType=DOUBLE}
        </if>
        <if test="backRatio != null and backRatio != ''">
            ,back_ratio = #{backRatio, jdbcType=FLOAT}
        </if>
        <if test="redRatio != null and redRatio != ''">
            ,red_ratio = #{redRatio, jdbcType=FLOAT}
        </if>
        <if test="companyName != null and companyName != ''">
            ,company_name = #{companyName, jdbcType=VARCHAR}
        </if>
        <if test="companyLead != null and companyLead != ''">
            ,company_lead = #{companyLead, jdbcType=VARCHAR}
        </if>
        <if test="companyPhone != null and companyPhone != ''">
            ,company_phone = #{companyPhone, jdbcType=VARCHAR}
        </if>
        <if test="lastLoginTime != null">
            <if test="username != null and username != ''">,</if>
            last_login_time = #{lastLoginTime, jdbcType=TIMESTAMP}
        </if>
        <if test="lastLoginIp != null and lastLoginIp != ''">
            ,last_login_ip = #{lastLoginIp, jdbcType=VARCHAR}
        </if>
        <if test="companyTel != null and companyTel != ''">
            ,company_tel = #{companyTel, jdbcType=VARCHAR}
        </if>
        <if test="companyAddress != null and companyAddress != ''">
            ,company_address = #{companyAddress, jdbcType=VARCHAR}
        </if>
        WHERE id = #{id}
    </update>

    <!--代理入金列表-->
    <resultMap id="proxyPayResultMap" type="com.xr.exchange.model.ProxyPayVo">
        <id column="payId" property="payId" jdbcType="INTEGER"/>
        <id column="username" property="username" jdbcType="VARCHAR"/>
        <id column="realname" property="realname" jdbcType="VARCHAR"/>
        <id column="phone" property="phone" jdbcType="VARCHAR"/>
        <id column="payMoney" property="payMoney" jdbcType="DECIMAL"/>
        <id column="payNo" property="payNo" jdbcType="VARCHAR"/>
        <id column="payTime" property="payTime" jdbcType="TIMESTAMP"/>
        <id column="payFlag" property="payFlag" jdbcType="INTEGER"/>
    </resultMap>
    <select id="getProxyPayList" resultMap="proxyPayResultMap">
        select a.id as payId,b.username,b.realname,b.phone,a.money as payMoney,a.pay_time as payTime,a.pay_flag as payFlag from t_admin_pay_info a
        left join t_admin b on a.admin_id = b.id
        where 1=1
        <if test="proxyPayListBean.conditions!=null and proxyPayListBean.conditions!=''">
            and (b.username LIKE '%' #{proxyPayListBean.conditions} '%' or b.realname LIKE '%' #{proxyPayListBean.conditions}
            '%')
        </if>
        <if test="proxyPayListBean.addStartTime!=null and proxyPayListBean.addStartTime!=''">
            AND a.pay_time &gt;= CONCAT(#{proxyPayListBean.addStartTime},' 00:00:00')
        </if>
        <if test="proxyPayListBean.addEndTime!=null and proxyPayListBean.addEndTime!=''">
            AND a.pay_time &lt;= CONCAT(#{proxyPayListBean.addEndTime},' 23:59:59')
        </if>
        <if test="proxyPayListBean.payFlag!=null and proxyPayListBean.payFlag!=''">
            AND a.pay_flag =#{proxyPayListBean.payFlag}
        </if>
        <if test="loginAdmin.level==1">
            AND b.jiaoyisuo_id = #{loginAdmin.id}
        </if>
        <if test="loginAdmin.level==2">
            AND b.yunying_id = #{loginAdmin.id}
        </if>
        <if test="loginAdmin.level==3">
            AND b.zonghe_id = #{loginAdmin.id}
        </if>
        <if test="loginAdmin.level==4">
            AND b.weiquan_id = #{loginAdmin.id}
        </if>
        order by a.pay_time desc
    </select>

    <!--代理出金列表-->
    <resultMap id="proxyPopResultMap" type="com.xr.exchange.model.ProxyPopVo">
        <id column="popId" property="popId" jdbcType="INTEGER"/>
        <id column="adminId" property="adminId" jdbcType="VARCHAR"/>
        <id column="username" property="username" jdbcType="VARCHAR"/>
        <id column="realname" property="realname" jdbcType="VARCHAR"/>
        <id column="money" property="money" jdbcType="DECIMAL"/>
        <id column="popMoney" property="popMoney" jdbcType="DECIMAL"/>
        <id column="popTime" property="popTime" jdbcType="TIMESTAMP"/>
        <id column="popAppTime" property="popAppTime" jdbcType="TIMESTAMP"/>
        <id column="popFlag" property="popFlag" jdbcType="INTEGER"/>
        <id column="popName" property="popName" jdbcType="VARCHAR"/>
        <id column="popCode" property="popCode" jdbcType="VARCHAR"/>
        <id column="popAccount" property="popAccount" jdbcType="VARCHAR"/>
        <id column="popPhone" property="popPhone" jdbcType="VARCHAR"/>
        <id column="popIdcard" property="popIdcard" jdbcType="VARCHAR"/>
        <id column="popDo" property="popDo" jdbcType="INTEGER"/>
        <id column="zongheName" property="zongheName" jdbcType="VARCHAR"/>
        <id column="weiquanName" property="weiquanName" jdbcType="VARCHAR"/>
        <id column="yunyingName" property="yunyingName" jdbcType="VARCHAR"/>
    </resultMap>
    <select id="getProxyPopList" resultMap="proxyPopResultMap">
        select a.id as popId,a.admin_id as adminId,b.username,b.phone,b.realname,a.pop_money as popMoney,a.pop_time as popTime,a.pop_flag as popFlag,a.pop_name as popName,a.pop_code as popCode,a.pop_account as popAccount,a.pop_phone as popPhone,a.pop_idcard as popIdcard from t_admin_pop_info a
        left join t_admin b on a.admin_id = b.id
        where 1=1
        <if test="proxyPopListBean.bankUserName!=null and proxyPopListBean.bankUserName!=''">
            and a.pop_name = #{proxyPopListBean.bankUserName}
        </if>
        <if test="proxyPopListBean.bankName!=null and proxyPopListBean.bankName!=''">
            and a.pop_account = #{proxyPopListBean.bankName}
        </if>

        <if test="proxyPopListBean.addStartTime!=null and proxyPopListBean.addStartTime!=''">
            AND a.pop_time &gt;= CONCAT(#{proxyPopListBean.addStartTime},' 00:00:00')
        </if>
        <if test="proxyPopListBean.addEndTime!=null and proxyPopListBean.addEndTime!=''">
            AND a.pop_time &lt;= CONCAT(#{proxyPopListBean.addEndTime},' 23:59:59')
        </if>
        <if test="proxyPopListBean.appStartTime!=null and proxyPopListBean.appStartTime!=''">
            AND a.pop_app_time &gt;= CONCAT(#{proxyPopListBean.appStartTime},' 00:00:00')
        </if>
        <if test="proxyPopListBean.appEndTime!=null and proxyPopListBean.appEndTime!=''">
            AND a.pop_app_time &lt;= CONCAT(#{proxyPopListBean.appEndTime},' 23:59:59')
        </if>
        <if test="proxyPopListBean.popFlag!=null and proxyPopListBean.popFlag!=''">
            AND a.pop_flag =#{proxyPopListBean.popFlag}
        </if>
        <if test="loginAdmin.level==1">
            AND b.jiaoyisuo_id = #{loginAdmin.id}
        </if>
        <if test="loginAdmin.level==2">
            AND b.yunying_id = #{loginAdmin.id}
        </if>
        <if test="loginAdmin.level==3">
            AND b.zonghe_id = #{loginAdmin.id}
        </if>
        <if test="loginAdmin.level==4">
            AND b.weiquan_id = #{loginAdmin.id}
        </if>
        order by a.pop_time desc
    </select>
    <!-- 代理出金驳回 -->
    <update id="rebutPop">
        UPDATE t_admin_pop_info
        SET pop_flag = #{proxyPopVo.popFlag},
        pop_app_time = NOW()
        WHERE 1 = 1
        and id = #{proxyPopVo.popId}
    </update>
    <update id="updateAdminMoney">
        UPDATE t_admin

        SET money =  #{money}+money

        WHERE 1 = 1
        and id = #{adminId}
    </update>
</mapper>